<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞—Ä–æ—á–Ω–æ–≥–æ –∑–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ 3.2</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background: radial-gradient(circle at 20% 20%, #1b2233 0%, #0b0e14 40%, #05070c 100%);color:#e9edf7;overflow-x:hidden;display:flex;flex-direction:row;transition:0.3s;}
body.light{background: radial-gradient(circle at 20% 20%, #f0f2f5 0%, #dce0e8 40%, #c7cbd6 100%);color:#111;}
body.light .menu{background:rgba(255,255,255,0.95);}
body.light .page{color:#111;}
body.light .review-container, body.light .block, body.light .card, body.light #previewInner, body.light #authInner, body.light .profile-container{background:rgba(255,255,255,0.95);color:#111;}
body.light input, body.light textarea{background:rgba(255,255,255,0.9);color:#111;border:1px solid #ccc;}
body.light input[type=range]{background:#ccc;}
body.light input[type=range]::-webkit-slider-thumb{background:#444;}
body.light input[type=range]::-moz-range-thumb{background:#444;}
body.light .save-btn, body.light #editBtn, body.light #deleteBtn, body.light #loginBtn, body.light #logoutBtn, body.light .auth-buttons button, body.light .tabs button{color:#111;background:rgba(200,200,255,0.2);}
body.light .tabs button.active{background:rgba(100,150,255,0.3);}
.menu{display:flex;flex-direction:column;width:60px;background:rgba(30,35,50,0.95);padding:20px 0;position:fixed;height:100vh;z-index:100;border-radius:0 12px 12px 0;box-shadow:2px 0 10px rgba(0,0,0,0.4);}
.menu button{background:none;border:none;color:#aaa;font-size:20px;margin:10px 0;cursor:pointer;display:flex;justify-content:center;align-items:center;transition:0.3s;}
.menu button.active{color:#fff;}
.menu button i{pointer-events:none;}
.page{display:none;padding:20px;padding-left:80px;flex:1;}
.page.active{display:block;}
.review-container{max-width:1000px;width:100%;margin:auto;padding:25px;background:rgba(18,22,30,0.85);backdrop-filter:blur(20px);border-radius:24px;box-shadow:0 0 60px rgba(0,0,0,0.7);transition: all 0.4s ease;position:relative;}
.top{display:flex;gap:20px;margin-bottom:25px;flex-wrap:wrap;}
.cover-wrapper{position:relative;cursor:pointer;}
.cover{width:180px;height:180px;border-radius:16px;background:linear-gradient(145deg,#1c2230,#11141b);object-fit:cover;box-shadow:0 0 20px rgba(0,0,0,0.6);transition:all 0.4s ease;}
.meta{flex:1;display:flex;flex-direction:column;gap:10px;}
.meta input{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:12px;color:#fff;font-size:14px;}
.award-container{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:5px;}
.award{display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;}
.award input{appearance:none;width:14px;height:14px;border-radius:50%;border:1px solid #555;background:#555;cursor:pointer;box-shadow:0 0 2px rgba(0,0,0,0.2);}
.award input:checked{background:#fff;box-shadow:0 0 6px #fff;}
.block{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:18px;padding:15px;margin-bottom:12px;box-shadow:0 0 20px rgba(0,0,0,0.4);overflow-x:hidden;transition:all 0.4s ease;}
.block.vibe{background:linear-gradient(90deg, rgba(120,60,255,0.15), rgba(255,60,180,0.1));border:1px solid rgba(160,90,255,0.4);}
.label{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:500;}
input[type=range]{-webkit-appearance:none;width:100%;height:10px;border-radius:5px;background: rgba(255,255,255,0.2);outline:none;box-shadow:0 0 4px rgba(255,255,255,0.3);}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;box-shadow:0 0 8px #fff;cursor:pointer;}
input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#fff;box-shadow:0 0 8px #fff;cursor:pointer;}
.result{text-align:right;margin-top:20px;font-size:48px;font-weight:700;}
.result .small{font-size:18px;opacity:0.4;}
textarea{width:100%;margin-top:15px;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#fff;min-height:120px;resize:none;overflow:auto;}
.save-btn{margin-top:15px;padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:0.3s;}
.save-btn:hover{background:rgba(255,255,255,0.1);}
#editBtn,#deleteBtn{margin-top:15px;padding:10px 16px;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:0.3s;}
#editBtn{background:rgba(100,150,255,0.2);color:#fff;}
#editBtn:hover{background:rgba(100,150,255,0.3);}
#deleteBtn{background:rgba(255,50,50,0.2);color:#fff;margin-left:8px;}
#deleteBtn:hover{background:rgba(255,50,50,0.3);}
.card{background:rgba(18,22,30,0.85);border-radius:16px;padding:10px 12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.3s ease;}
.card:hover{transform:scale(1.02);}
.card .rank{width:20px;text-align:center;font-weight:700;color:#fff;}
.card img{width:40px;height:40px;border-radius:6px;object-fit:cover;}
.card .title{font-weight:700;flex:1;font-size:14px;}
.card .score{font-size:16px;font-weight:600;margin-left:8px;}
.card .badges{display:flex;gap:4px;margin-left:5px;flex-wrap:wrap;}
.card .badges span{background:rgba(100,150,255,0.2);color:#fff;font-size:10px;font-weight:600;padding:2px 5px;border-radius:6px;}
#previewModal, #authModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:0.3s;}
#previewModal.show, #authModal.show{opacity:1;pointer-events:auto;}
#previewInner, #authInner{background: rgba(18,22,30,0.95);padding:20px;border-radius:20px;max-width:90%;width:90%;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;gap:15px;box-shadow:0 0 40px rgba(0,0,0,0.7);transform:scale(0.8);transition:all 0.3s ease;}
#previewModal.show #previewInner, #authModal.show #authInner{transform:scale(1);}
#previewInner .author-info, #authInner .author-info{display:flex;align-items:center;gap:5px;font-size:12px;opacity:0.8;margin-top:5px;}
.profile-container{max-width:600px;width:100%;margin:auto;padding:20px;background:rgba(18,22,30,0.85);border-radius:20px;box-shadow:0 0 40px rgba(0,0,0,0.7);display:flex;flex-direction:column;gap:12px;align-items:center;position:relative;}
#profileAvatar{width:100px;height:100px;border-radius:50%;background:linear-gradient(145deg,#1c2230,#11141b);object-fit:cover;box-shadow:0 0 20px rgba(0,0,0,0.6);}
#profileNick{font-weight:600;font-size:16px;}
#loginBtn,#logoutBtn{padding:10px 16px;border:none;border-radius:12px;background:rgba(100,150,255,0.2);color:#fff;font-weight:600;cursor:pointer;transition:0.3s;}
#loginBtn:hover,#logoutBtn:hover{background:rgba(100,150,255,0.3);}
.version-label{position:fixed;bottom:5px;right:10px;font-size:12px;opacity:0.5;}
.toast-container{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:500;}
.toast{padding:10px 16px;border-radius:12px;color:#fff;font-weight:600;background:rgba(100,150,255,0.9);box-shadow:0 0 20px rgba(0,0,0,0.4);animation:toastIn 0.3s forwards;opacity:0;}
.toast.success{background:rgba(100,255,150,0.9);}
.toast.error{background:rgba(255,100,100,0.9);}
@keyframes toastIn{from{opacity:0;transform:translateX(50px);}to{opacity:1;transform:translateX(0);}}
.tabs{display:flex;gap:10px;margin-bottom:10px;}
.tabs button{flex:1;padding:10px;border-radius:12px;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer;}
.tabs button.active{background:rgba(100,150,255,0.2);}
.auth-buttons button{flex:1;margin-top:10px;padding:10px;border:none;border-radius:12px;color:#fff;background:rgba(100,150,255,0.2);cursor:pointer;}
.auth-buttons button:hover{background:rgba(100,150,255,0.3);}
.avatar-picker{width:60px;height:60px;border-radius:50%;object-fit:cover;margin:auto;cursor:pointer;display:block;background:linear-gradient(145deg,#1c2230,#11141b);}
@media(max-width:480px){
  .cover{width:140px;height:140px;}
  .review-container{padding:15px;}
  .block{padding:12px;}
  .result{font-size:36px;}
  .card .title{font-size:12px;}
  .card .score{font-size:14px;}
}
</style>
<body>

<div class="menu">
  <button class="active" onclick="openPage('home',event)"><i class="fa-solid fa-house"></i></button>
  <button onclick="openPage('review',event)"><i class="fa-solid fa-star"></i></button>
  <button onclick="openPage('profile',event)"><i class="fa-solid fa-user"></i></button>
</div>

<div id="home" class="page active"></div>

<div id="review" class="page">
  <div class="review-container">
    <div class="top">
      <div class="cover-wrapper" onclick="coverInput.click()">
        <img id="coverPreview" class="cover">
        <input type="file" id="coverInput" hidden>
      </div>
      <div class="meta">
        <input type="text" id="artist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">
        <input type="text" id="album" placeholder="–ê–ª—å–±–æ–º">
        <div class="author-info" id="reviewAuthor"></div>
        <div class="award-container">
          <label class="award"><input type="checkbox" id="a1"> üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a2"> üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a3"> üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a4"> üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞</label>
        </div>
      </div>
    </div>
    <div class="block"><div class="label">–†–∏—Ñ–º—ã / –û–±—Ä–∞–∑—ã <span id="v1">5</span></div><input type="range" min="1" max="10" value="5" id="s1"></div>
    <div class="block"><div class="label">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ / –†–∏—Ç–º–∏–∫–∞ <span id="v2">5</span></div><input type="range" min="1" max="10" value="5" id="s2"></div>
    <div class="block"><div class="label">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª—è <span id="v3">5</span></div><input type="range" min="1" max="10" value="5" id="s3"></div>
    <div class="block"><div class="label">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å / –•–∞—Ä–∏–∑–º–∞ <span id="v4">5</span></div><input type="range" min="1" max="10" value="5" id="s4"></div>
    <div class="block vibe"><div class="label">–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ / –í–∞–π–± <span id="v5">5</span></div><input type="range" min="1" max="10" value="5" id="s5"></div>
    <div class="result"><span id="total">28</span><span class="small"> / 90</span></div>
    <textarea id="text" placeholder="–¢–µ–∫—Å—Ç —Ä–µ—Ü–µ–Ω–∑–∏–∏"></textarea>
    <button class="save-btn" onclick="saveReview()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é</button>
  </div>
</div>

<div id="profile" class="page">
  <div class="profile-container">
    <img id="profileAvatar" src="">
    <div id="profileNick"></div>
    <button id="loginBtn" onclick="openAuthModal()">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">–í—ã–π—Ç–∏</button>
    <button onclick="toggleTheme()">üí° –¢–µ–º–∞</button>
  </div>
</div>

<div id="previewModal">
  <div id="previewInner">
    <div class="review-container" id="previewContent"></div>
    <div class="author-info" id="previewAuthor"></div>
    <div style="display:flex;justify-content:center;">
      <button id="editBtn">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é</button>
      <button id="deleteBtn">–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é</button>
    </div>
  </div>
</div>

<div id="authModal">
  <div id="authInner">
    <div class="tabs">
      <button class="active" id="tabLogin" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
      <button id="tabRegister" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <img class="avatar-picker" id="authAvatar" src="" style="display:none;">
    <input type="file" id="authAvatarInput" hidden>
    <input type="text" id="authNick" placeholder="–ù–∏–∫">
    <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å">
    <div class="auth-buttons">
      <button id="loginBtnModal" onclick="authLogin()">–í—Ö–æ–¥</button>
      <button id="registerBtnModal" onclick="authRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="version-label">3.2</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------- FIREBASE ----------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "limteam-46e0f.firebaseapp.com",
  databaseURL: "https://limteam-46e0f-default-rtdb.firebaseio.com/",
  projectId: "limteam-46e0f",
  storageBucket: "limteam-46e0f.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- GLOBAL ----------
let editingIndex=null;
let currentUser=null;
let currentAvatar="";
let authTab='login';
let currentKey=null;

// ---------- TOAST ----------
function showToast(msg,type='default'){
  const container=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className='toast '+(type==='success'?'success':type==='error'?'error':'');
  t.innerText=msg;
  container.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

// ---------- PAGES ----------
function openPage(id,event){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(event) document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  if(event) event.currentTarget.classList.add("active");
}

// ---------- COVER ----------
const coverInput=document.getElementById("coverInput");
coverInput.addEventListener("change", function(e){
  const reader=new FileReader();
  reader.onload=function(){ document.getElementById("coverPreview").src=reader.result; }
  reader.readAsDataURL(e.target.files[0]);
});

// ---------- SLIDERS ----------
const vibeMultipliers={1:1,2:1.0675,3:1.1349,4:1.2024,5:1.2699,6:1.3373,7:1.4048,8:1.4723,9:1.5397,10:1.6072};
for(let i=1;i<=5;i++)document.getElementById("s"+i).addEventListener("input",updateScore);
function updateScore(){
  let base=0;
  for(let i=1;i<=4;i++){
    let v=parseInt(document.getElementById("s"+i).value);
    document.getElementById("v"+i).innerText=v;
    updateSliderProgress(document.getElementById("s"+i));
    base+=v;
  }
  let vibe=parseInt(document.getElementById("s5").value);
  document.getElementById("v5").innerText=vibe;
  updateSliderProgress(document.getElementById("s5"));
  let final=Math.round((base*1.4)*vibeMultipliers[vibe]);
  document.getElementById("total").innerText=final;
}
function updateSliderProgress(slider){
  let val=(slider.value-slider.min)/(slider.max-slider.min)*100;
  slider.style.background=`linear-gradient(to right, rgba(100,150,255,0.6) 0%, rgba(100,150,255,0.6) ${val}%, rgba(255,255,255,0.2) ${val}%, rgba(255,255,255,0.2) 100%)`;
}
updateScore();

// ---------- SAVE REVIEW ----------
function saveReview(){
  if(!currentUser) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!","error");
  const review = {
    author: currentUser,
    avatar: currentAvatar,
    artist: document.getElementById("artist").value.trim(),
    album: document.getElementById("album").value.trim(),
    cover: document.getElementById("coverPreview").src||"",
    scores:[...Array(5)].map((_,i)=>parseInt(document.getElementById("s"+(i+1)).value)),
    text: document.getElementById("text").value,
    total: parseInt(document.getElementById("total").innerText),
    awards:[...document.querySelectorAll(".award input")].map(inp=>inp.checked)
  };
  if(editingIndex!==null){
    db.ref("reviews/"+editingIndex).set(review);
    editingIndex=null;
    showToast("–†–µ—Ü–µ–Ω–∑–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞","success");
  } else {
    db.ref("reviews").push(review);
    showToast("–†–µ—Ü–µ–Ω–∑–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞","success");
  }
  resetReviewForm();
  loadReviews();
}

function resetReviewForm(){
  document.getElementById("coverPreview").src="";
  document.getElementById("text").value="";
  document.getElementById("artist").value="";
  document.getElementById("album").value="";
  for(let i=1;i<=5;i++){document.getElementById("s"+i).value=5;updateSliderProgress(document.getElementById("s"+i));}
  document.querySelectorAll(".award input").forEach(inp=>inp.checked=false);
  updateScore();
}

// ---------- LOAD REVIEWS ----------
function loadReviews(){
  db.ref("reviews").on("value", snapshot=>{
    const reviews = snapshot.val() || {};
    renderTopReviews(Object.entries(reviews));
  });
}

function renderTopReviews(entries){
  const list=document.getElementById("home");
  list.innerHTML="";
  entries.sort((a,b)=>b[1].total-a[1].total).forEach(([key,r],i)=>{
    const card=document.createElement("div");
    card.className="card";
    let badges = r.awards.map((a,j)=>a?`<span>${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</span>`:"").filter(Boolean).join("");
    if(!badges) badges='<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>';
    card.dataset.key=key;
    card.innerHTML=`<div class="rank">${i+1}</div>${r.cover?`<img src="${r.cover}">`:""}<span class="title">${r.artist||""} ‚Äî ${r.album||""}</span><div class="badges">${badges}</div><span class="score">${r.total||0}</span>`;
    card.onclick=()=>showPreview(key,r);
    list.appendChild(card);
  });
}

// ---------- PREVIEW MODAL ----------
const previewModal=document.getElementById("previewModal");
const previewContent=document.getElementById("previewContent");
const editBtn=document.getElementById("editBtn");
const deleteBtn=document.getElementById("deleteBtn");

function showPreview(key,r){
  currentKey=key;
  previewContent.innerHTML=`<div class="top">
    <div class="cover-wrapper"><img class="cover" src="${r.cover||''}"></div>
    <div class="meta">
      <input type="text" value="${r.artist||''}" disabled>
      <input type="text" value="${r.album||''}" disabled>
      <div class="author-info"><img src="${r.avatar||''}" style="width:25px;height:25px;border-radius:50%;vertical-align:middle;margin-right:5px;"> ${r.author}</div>
      <div class="award-container">
        ${r.awards.map((a,j)=>a?`<label class="award"><input type="checkbox" checked disabled> ${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</label>`:"").filter(Boolean).join('') || '<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>'}
      </div>
    </div>
  </div>
  ${r.scores.map((s,i)=>`<div class="block ${i===4?'vibe':''}"><div class="label">${["–†–∏—Ñ–º—ã / –û–±—Ä–∞–∑—ã","–°—Ç—Ä—É–∫—Ç—É—Ä–∞ / –†–∏—Ç–º–∏–∫–∞","–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª—è","–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å / –•–∞—Ä–∏–∑–º–∞","–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ / –í–∞–π–±"][i]} <span>${s}</span></div></div>`).join('')}
  <div class="result"><span>${r.total}</span><span class="small"> / 90</span></div>
  <textarea disabled>${r.text||''}</textarea>`;

  if(currentUser!==r.author){editBtn.style.display="none"; deleteBtn.style.display="none";}
  else{editBtn.style.display="block"; deleteBtn.style.display="block";}
  previewModal.classList.add('show');
}

editBtn.onclick=()=>{
  previewModal.classList.remove('show');
  db.ref("reviews/"+currentKey).get().then(snap=>{
    const r = snap.val();
    editingIndex=currentKey;
    document.getElementById("coverPreview").src=r.cover;
    document.getElementById("text").value=r.text;
    document.getElementById("artist").value=r.artist;
    document.getElementById("album").value=r.album;
    r.scores.forEach((v,i)=>{document.getElementById("s"+(i+1)).value=v;updateSliderProgress(document.getElementById("s"+(i+1)));});
    document.querySelectorAll(".award input").forEach((inp,i)=>inp.checked=r.awards[i]);
    updateScore();
    openPage('review');
  });
}

deleteBtn.onclick=()=>{
  showCustomConfirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–µ—Ü–µ–Ω–∑–∏—é?", ()=>{
    db.ref("reviews/"+currentKey).remove();
    previewModal.classList.remove('show');
    showToast("–†–µ—Ü–µ–Ω–∑–∏—è —É–¥–∞–ª–µ–Ω–∞","success");
  });
}

// ---------- CUSTOM CONFIRM ----------
function showCustomConfirm(message,callback){
  const overlay=document.createElement('div');
  overlay.style.position='fixed';
  overlay.style.top=0; overlay.style.left=0; overlay.style.width='100%'; overlay.style.height='100%';
  overlay.style.background='rgba(0,0,0,0.7)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=1000;
  const box=document.createElement('div');
  box.style.background='rgba(18,22,30,0.95)'; box.style.padding='20px'; box.style.borderRadius='20px'; box.style.textAlign='center';
  box.innerHTML=`<p style="margin-bottom:15px">${message}</p>`;
  const yes=document.createElement('button'); yes.innerText='–î–∞'; yes.style.margin='5px'; yes.style.padding='8px 16px'; yes.style.border='none'; yes.style.borderRadius='12px'; yes.style.cursor='pointer'; yes.style.background='rgba(255,50,50,0.2)'; yes.style.color='#fff';
  const no=document.createElement('button'); no.innerText='–ù–µ—Ç'; no.style.margin='5px'; no.style.padding='8px 16px'; no.style.border='none'; no.style.borderRadius='12px'; no.style.cursor='pointer'; no.style.background='rgba(100,150,255,0.2)'; no.style.color='#fff';
  yes.onclick=()=>{callback(); overlay.remove();}
  no.onclick=()=>{overlay.remove();}
  box.appendChild(yes); box.appendChild(no); overlay.appendChild(box); document.body.appendChild(overlay);
}

previewModal.addEventListener('click', e=>{if(e.target===previewModal) previewModal.classList.remove('show');});

// ---------- AUTH ----------
// ---------- AUTH ----------
const authModal=document.getElementById("authModal");
const authAvatar=document.getElementById("authAvatar");
const authAvatarInput=document.getElementById("authAvatarInput");
const authNick=document.getElementById("authNick");
const authPass=document.getElementById("authPass");
const loginBtnModal=document.getElementById("loginBtnModal");
const registerBtnModal=document.getElementById("registerBtnModal");

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å —Å–∞–π—Ç–∞ –∫ –ø–æ–ª—è–º
[authNick, authPass].forEach(input=>{
  input.style.background="rgba(255,255,255,0.04)";
  input.style.border="1px solid rgba(255,255,255,0.08)";
  input.style.padding="10px";
  input.style.borderRadius="12px";
  input.style.color="#fff";
  input.style.fontSize="14px";
});

// –ê–≤–∞—Ç–∞—Ä
authAvatar.addEventListener("click", ()=>authAvatarInput.click());
authAvatarInput.addEventListener("change", e=>{
  const reader=new FileReader();
  reader.onload=function(){ authAvatar.src=reader.result; currentAvatar=reader.result; }
  reader.readAsDataURL(e.target.files[0]);
});

function openAuthModal(){ authModal.classList.add('show'); }
authModal.addEventListener('click', e=>{ if(e.target===authModal) authModal.classList.remove('show'); });

function switchAuthTab(tab){
  authTab = tab;
  document.getElementById('tabLogin').classList.toggle('active', tab==='login');
  document.getElementById('tabRegister').classList.toggle('active', tab==='register');
  loginBtnModal.style.display = tab==='login' ? 'block':'none';
  registerBtnModal.style.display = tab==='register' ? 'block':'none';
  authAvatar.style.display = tab==='register' ? 'block':'none';
  if(tab==='register'){ authAvatar.style.display='block'; authAvatar.src=''; currentAvatar='';}
}

function authLogin(){
  if(authTab!=='login') return;
  const nick = authNick.value.trim();
  const pass = authPass.value;
  if(!nick || !pass) return showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å","error");
  db.ref("users/@"+nick).get().then(snap=>{
    if(!snap.exists()) return showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω","error");
    const user = snap.val();
    if(user.password!==pass) return showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å","error");
    currentUser="@"+nick;
    currentAvatar=user.avatar||"";
    profileAvatar.src=currentAvatar;
    profileNick.innerText=nick;
    authModal.classList.remove("show");
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    localStorage.setItem("user", currentUser);
    localStorage.setItem("avatar", currentAvatar);
    showToast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω","success");
    loadReviews();
  });
}

function authRegister(){
  if(authTab!=='register') return;
  let nick = authNick.value.trim();
  const pass = authPass.value;
  if(!nick || !pass) return showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å","error");

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
  if(/\s/.test(nick)) return showToast("–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã","error");

  nick = nick.replace(/\s/g,''); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —É–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã
  const userKey = "@"+nick;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –Ω–∏–∫
  db.ref("users/"+userKey).get().then(snap=>{
    if(snap.exists()) return showToast("–ù–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç","error");

    currentUser=userKey;
    db.ref("users/"+currentUser).set({password:pass,avatar:currentAvatar});
    profileAvatar.src=currentAvatar;
    profileNick.innerText=nick;
    authModal.classList.remove("show");
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    localStorage.setItem("user", currentUser);
    localStorage.setItem("avatar", currentAvatar);
    showToast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞","success");
    loadReviews();
  });
}
// ---------- LOGOUT ----------
function logout(){
  currentUser=null;
  currentAvatar="";
  profileAvatar.src="";
  profileNick.innerText="";
  document.getElementById("loginBtn").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  localStorage.removeItem("user");
  localStorage.removeItem("avatar");
  showToast("–í—ã –≤—ã—à–ª–∏","success");
}

// ---------- INIT ----------
openPage('home');
loadReviews();

// ---------- LOAD SAVED USER ----------
if(localStorage.getItem("user")){
  currentUser=localStorage.getItem("user");
  currentAvatar=localStorage.getItem("avatar")||"";
  profileAvatar.src=currentAvatar;
  profileNick.innerText=currentUser.replace("@","");
  document.getElementById("loginBtn").style.display="none";
  document.getElementById("logoutBtn").style.display="block";
  loadReviews();
}

// ---------- THEME ----------
function toggleTheme(){ document.body.classList.toggle('light'); }

switchAuthTab('login');
</script>
</body>
</html>

