<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>LimTeam Reviews 4.0</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
</head>
<body>

<!-- ---------------- PAGES ---------------- -->
<div id="home" class="page active"></div>
<div id="review" class="page"></div>

<!-- ---------------- MODALS ---------------- -->
<div id="previewModal"></div>
<div id="authModal"></div>

<!-- ---------------- PROFILE ---------------- -->
<img id="profileAvatar">
<span id="profileNick"></span>
<button id="loginBtn" onclick="openAuthModal()">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" onclick="logout()" style="display:none">–í—ã–π—Ç–∏</button>

<script>
const firebaseConfig = {
  authDomain: "limteam-46e0f.firebaseapp.com",
  databaseURL: "https://limteam-46e0f-default-rtdb.firebaseio.com/",
  projectId: "limteam-46e0f",
  storageBucket: "limteam-46e0f.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- Global ----------
let editingIndex = null;
let currentUser = null;
let currentAvatar = "";
let authTab = 'login'; // 'login' –∏–ª–∏ 'register'

// ---------- Pages ----------
function openPage(id, event){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(event) document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  if(event) event.currentTarget.classList.add("active");
}

// ---------- Cover ----------
const coverInput = document.getElementById("coverInput");
coverInput.addEventListener("change", function(e){
  const reader = new FileReader();
  reader.onload = ()=> document.getElementById("coverPreview").src = reader.result;
  reader.readAsDataURL(e.target.files[0]);
});

// ---------- Profile ----------
const profileAvatar = document.getElementById("profileAvatar");
const profileNick = document.getElementById("profileNick");

// ---------- Sliders ----------
const vibeMultipliers = {1:1,2:1.0675,3:1.1349,4:1.2024,5:1.2699,6:1.3373,7:1.4048,8:1.4723,9:1.5397,10:1.6072};
for(let i=1;i<=5;i++) document.getElementById("s"+i).addEventListener("input", updateScore);

function updateScore(){
  let base=0;
  for(let i=1;i<=4;i++){
    let v=parseInt(document.getElementById("s"+i).value);
    document.getElementById("v"+i).innerText=v;
    updateSliderProgress(document.getElementById("s"+i));
    base+=v;
  }
  let vibe = parseInt(document.getElementById("s5").value);
  document.getElementById("v5").innerText = vibe;
  updateSliderProgress(document.getElementById("s5"));
  let final = Math.round((base*1.4)*vibeMultipliers[vibe]);
  document.getElementById("total").innerText = final;
}

function updateSliderProgress(slider){
  let val = (slider.value-slider.min)/(slider.max-slider.min)*100;
  slider.style.background = `linear-gradient(to right, rgba(100,150,255,0.6) 0%, rgba(100,150,255,0.6) ${val}%, rgba(255,255,255,0.2) ${val}%, rgba(255,255,255,0.2) 100%)`;
}
updateScore();

// ---------- Save Review ----------
function saveReview(){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");
  const review = {
    author: currentUser,
    avatar: currentAvatar,
    artist: document.getElementById("artist").value.trim(),
    album: document.getElementById("album").value.trim(),
    cover: document.getElementById("coverPreview").src||"",
    scores: [...Array(5)].map((_,i)=>parseInt(document.getElementById("s"+(i+1)).value)),
    text: document.getElementById("text").value,
    total: parseInt(document.getElementById("total").innerText),
    awards: [...document.querySelectorAll(".award input")].map(inp=>inp.checked)
  };
  if(editingIndex !== null){
    db.ref("reviews/"+editingIndex).set(review);
    editingIndex = null;
  } else {
    db.ref("reviews").push(review);
  }
  resetReviewForm();
  loadReviews();
}

// ---------- Reset Form ----------
function resetReviewForm(){
  document.getElementById("coverPreview").src = "";
  coverInput.value = "";
  document.getElementById("text").value = "";
  document.getElementById("artist").value = "";
  document.getElementById("album").value = "";
  for(let i=1;i<=5;i++){document.getElementById("s"+i).value=5;updateSliderProgress(document.getElementById("s"+i));}
  document.querySelectorAll(".award input").forEach(inp=>inp.checked=false);
  updateScore();
}

// ---------- Load Reviews ----------
function loadReviews(){
  db.ref("reviews").on("value", snapshot=>{
    const reviews = snapshot.val() || {};
    renderTopReviews(Object.entries(reviews));
  });
}

// ---------- Render ----------
function renderTopReviews(entries){
  const list=document.getElementById("home");
  list.innerHTML="";
  entries.sort((a,b)=>b[1].total-a[1].total).forEach(([key,r],i)=>{
    const card=document.createElement("div");
    card.className="card";
    let badges = r.awards.map((a,j)=>a?`<span>${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</span>`:"").filter(Boolean).join("");
    if(!badges) badges='<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>';
    card.dataset.key = key;
    card.innerHTML=`<div class="rank">${i+1}</div>${r.cover?`<img src="${r.cover}">`:""}<span class="title">${r.artist} ‚Äî ${r.album}</span><div class="badges">${badges}</div><span class="score">${r.total}</span>`;
    card.onclick = ()=>showPreview(key,r);
    list.appendChild(card);
  });
}

// ---------- Modal Review ----------
const previewModal = document.getElementById("previewModal");
const previewContent = document.getElementById("previewContent");
const previewAuthor = document.getElementById("previewAuthor");
const editBtn = document.getElementById("editBtn");
const deleteBtn = document.getElementById("deleteBtn");
let currentKey = null;

function showPreview(key,r){
  currentKey = key;
  previewContent.innerHTML=`<div class="top">
    <div class="cover-wrapper"><img class="cover" src="${r.cover||''}"></div>
    <div class="meta">
      <input type="text" value="${r.artist}" disabled>
      <input type="text" value="${r.album}" disabled>
      <div class="author-info"><img src="${r.avatar||''}" style="width:25px;height:25px;border-radius:50%;vertical-align:middle;margin-right:5px;"> ${r.author}</div>
      <div class="award-container">
        ${r.awards.map((a,j)=>a?`<label class="award"><input type="checkbox" checked disabled> ${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</label>`:"").filter(Boolean).join('') || '<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>'}
      </div>
    </div>
  </div>
  ${r.scores.map((s,i)=>`<div class="block ${i===4?'vibe':''}"><div class="label">${["–†–∏—Ñ–º—ã / –û–±—Ä–∞–∑—ã","–°—Ç—Ä—É–∫—Ç—É—Ä–∞ / –†–∏—Ç–º–∏–∫–∞","–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª—è","–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å / –•–∞—Ä–∏–∑–º–∞","–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ / –í–∞–π–±"][i]} <span>${s}</span></div></div>`).join('')}
  <div class="result"><span>${r.total}</span><span class="small"> / 90</span></div>
  <textarea disabled>${r.text}</textarea>`;
  previewModal.classList.add('show');
}

editBtn.onclick = ()=>{
  previewModal.classList.remove('show');
  db.ref("reviews/"+currentKey).get().then(snap=>{
    const r = snap.val();
    editingIndex = currentKey;
    document.getElementById("coverPreview").src = r.cover;
    document.getElementById("text").value = r.text;
    document.getElementById("artist").value = r.artist;
    document.getElementById("album").value = r.album;
    r.scores.forEach((v,i)=>{document.getElementById("s"+(i+1)).value=v;updateSliderProgress(document.getElementById("s"+(i+1)));});
    document.querySelectorAll(".award input").forEach((inp,i)=>inp.checked=r.awards[i]);
    updateScore();
    openPage('review');
  });
}

deleteBtn.onclick = ()=>{
  if(!confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–µ—Ü–µ–Ω–∑–∏—é?")) return;
  db.ref("reviews/"+currentKey).remove();
  previewModal.classList.remove('show');
}

// ---------- Auth Modal ----------
const authModal = document.getElementById("authModal");
const authAvatar = document.getElementById("authAvatar");
const authNick = document.getElementById("authNick");
const authPass = document.getElementById("authPass");
const loginBtnModal = document.getElementById("loginBtnModal");
const registerBtnModal = document.getElementById("registerBtnModal");

function openAuthModal(){ authModal.classList.add('show'); }
authModal.addEventListener('click', e=>{if(e.target===authModal) authModal.classList.remove('show');});

// –í—ã–∑–æ–≤ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
authAvatar.addEventListener("click", ()=>{ if(authTab==='register') authPass.click(); });

function switchAuthTab(tab){
  authTab = tab;
  document.getElementById('tabLogin').classList.toggle('active', tab==='login');
  document.getElementById('tabRegister').classList.toggle('active', tab==='register');
  loginBtnModal.style.display = tab==='login' ? 'block':'none';
  registerBtnModal.style.display = tab==='register' ? 'block':'none';
}

// ---------- Login ----------
function authLogin(){
  if(authTab!=='login') return;
  const nick = authNick.value.trim();
  const pass = authPass.value;
  if(!nick || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");
  db.ref("users/@"+nick).get().then(snap=>{
    if(!snap.exists()) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    const user = snap.val();
    if(user.password!==pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    currentUser = "@"+nick;
    currentAvatar = user.avatar || "";
    profileAvatar.src = currentAvatar;
    profileNick.innerText = nick;
    authModal.classList.remove("show");
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    localStorage.setItem("user", currentUser);
    localStorage.setItem("avatar", currentAvatar);
    loadReviews();
  });
}

// ---------- Register ----------
function authRegister(){
  if(authTab!=='register') return;
  const nick = authNick.value.trim();
  const pass = authPass.value;
  if(!nick || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");
  if(nick.length<3) return alert("–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 3 —Å–∏–º–≤–æ–ª–æ–≤");
  if(pass.length<5) return alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 5 —Å–∏–º–≤–æ–ª–æ–≤");

  db.ref("users/@"+nick).get().then(snap=>{
    if(snap.exists()) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
    currentUser = "@"+nick;
    db.ref("users/"+currentUser).set({password: pass, avatar: currentAvatar || ""});
    profileAvatar.src = currentAvatar;
    profileNick.innerText = nick;
    authModal.classList.remove("show");
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    localStorage.setItem("user", currentUser);
    localStorage.setItem("avatar", currentAvatar || "");
    loadReviews();
  });
}

// ---------- Logout ----------
function logout(){
  currentUser=null;
  currentAvatar="";
  profileAvatar.src="";
  profileNick.innerText="";
  document.getElementById("loginBtn").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  localStorage.removeItem("user");
  localStorage.removeItem("avatar");
}

// ---------- Init ----------
openPage('home');
loadReviews();

// ---------- Load Saved User ----------
if(localStorage.getItem("user")){
  currentUser = localStorage.getItem("user");
  currentAvatar = localStorage.getItem("avatar") || "";
  profileAvatar.src = currentAvatar;
  profileNick.innerText = currentUser.replace("@","");
  document.getElementById("loginBtn").style.display="none";
  document.getElementById("logoutBtn").style.display="block";
  loadReviews();
}

// ---------- Initialize Auth Tab ----------
switchAuthTab('login');
</script>
</body>
</html>