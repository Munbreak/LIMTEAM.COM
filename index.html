<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞—Ä–æ—á–Ω–æ–≥–æ –∑–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
/* (–¢–≤–æ–π CSS –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background: radial-gradient(circle at 20% 20%, #1b2233 0%, #0b0e14 40%, #05070c 100%);color:#e9edf7;overflow-x:hidden;display:flex;flex-direction:row;}
.menu{display:flex;flex-direction:column;width:60px;background:rgba(30,35,50,0.95);padding:20px 0;position:fixed;height:100vh;z-index:100;border-radius:0 12px 12px 0;box-shadow:2px 0 10px rgba(0,0,0,0.4);}
.menu button{background:none;border:none;color:#aaa;font-size:20px;margin:10px 0;cursor:pointer;display:flex;justify-content:center;align-items:center;transition:0.3s;}
.menu button.active{color:#fff;}
.menu button i{pointer-events:none;}
.page{display:none;padding:20px;padding-left:80px;flex:1;}
.page.active{display:block;}
/* ... –æ—Å—Ç–∞–ª—å–Ω–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
</style>
</head>
<body>

<div class="menu">
  <button class="active" onclick="openPage('home',event)"><i class="fa-solid fa-house"></i></button>
  <button onclick="openPage('review',event)"><i class="fa-solid fa-star"></i></button>
  <button onclick="openPage('profile',event)"><i class="fa-solid fa-user"></i></button>
</div>

<div id="home" class="page active"></div>

<div id="review" class="page">
  <div class="review-container">
    <div class="top">
      <div class="cover-wrapper" onclick="coverInput.click()">
        <img id="coverPreview" class="cover">
        <input type="file" id="coverInput" hidden>
      </div>
      <div class="meta">
        <input type="text" id="artist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">
        <input type="text" id="album" placeholder="–ê–ª—å–±–æ–º">
        <div class="award-container">
          <label class="award"><input type="checkbox" id="a1"> üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a2"> üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a3"> üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞</label>
          <label class="award"><input type="checkbox" id="a4"> üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞</label>
        </div>
      </div>
    </div>
    <div class="block"><div class="label">–†–∏—Ñ–º—ã / –û–±—Ä–∞–∑—ã <span id="v1">5</span></div><input type="range" min="1" max="10" value="5" id="s1"></div>
    <div class="block"><div class="label">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ / –†–∏—Ç–º–∏–∫–∞ <span id="v2">5</span></div><input type="range" min="1" max="10" value="5" id="s2"></div>
    <div class="block"><div class="label">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª—è <span id="v3">5</span></div><input type="range" min="1" max="10" value="5" id="s3"></div>
    <div class="block"><div class="label">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å / –•–∞—Ä–∏–∑–º–∞ <span id="v4">5</span></div><input type="range" min="1" max="10" value="5" id="s4"></div>
    <div class="block vibe"><div class="label">–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ / –í–∞–π–± <span id="v5">5</span></div><input type="range" min="1" max="10" value="5" id="s5"></div>
    <div class="result"><span id="total">28</span><span class="small"> / 90</span></div>
    <textarea id="text" placeholder="–¢–µ–∫—Å—Ç —Ä–µ—Ü–µ–Ω–∑–∏–∏"></textarea>
    <button class="save-btn" onclick="saveReview()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é</button>
  </div>
</div>

<div id="profile" class="page">
  <div class="profile-container">
    <div style="display:flex;align-items:center;gap:12px;flex-direction:column;">
      <div id="avatarPreview">
        <span id="avatarPlus">+</span>
        <img id="avatarImg">
      </div>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button onclick="openAuth()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</button>
        <button id="logoutBtn">–í—ã–π—Ç–∏</button>
      </div>
      <div id="welcomeMsg" style="margin-top:8px;font-size:14px;opacity:0.7;"></div>
    </div>
  </div>
</div>

<!-- (–ú–æ–¥–∞–ª–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "limteam-46e0f.firebaseapp.com",
  databaseURL: "https://limteam-46e0f-default-rtdb.firebaseio.com",
  projectId: "limteam-46e0f",
  storageBucket: "limteam-46e0f.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// ---------- Global ----------
let editingIndex=null;
let currentUser="";

// ---------- Avatar ----------
const avatarInput = document.createElement("input");
avatarInput.type="file";
avatarInput.addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const img = document.getElementById("avatarImg");
    img.src = reader.result;
    img.style.display = "block";
    document.getElementById("avatarPlus").style.display = "none";
    localStorage.setItem("avatar", reader.result);
  }
  reader.readAsDataURL(file);
});
document.getElementById("avatarPreview").addEventListener("click",()=>avatarInput.click());

// ---------- Auth Modal ----------
function openAuth(){ document.getElementById("authModal").classList.add("show"); document.getElementById("authMsg").innerText=""; }
function closeAuth(){ document.getElementById("authModal").classList.remove("show"); }

// ---------- Logout ----------
document.getElementById("logoutBtn").onclick = () => {
  currentUser = "";
  localStorage.removeItem("nickname");
  localStorage.removeItem("avatar");
  document.getElementById("welcomeMsg").innerText = "";
  const img = document.getElementById("avatarImg");
  img.src = "";
  img.style.display = "none";
  document.getElementById("avatarPlus").style.display = "block";
};

// ---------- Registration ----------
document.getElementById("btnRegister").onclick = () => {
  let nick = document.getElementById("authNick").value.trim();
  let pass = document.getElementById("authPass").value.trim();
  const msg = document.getElementById("authMsg");
  if(!nick||!pass){msg.innerText="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å!";return;}
  if(/\s/.test(nick)){msg.innerText="–ù–∏–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã!";return;}
  db.ref("users/"+nick).get().then(snap=>{
    if(snap.exists()){msg.innerText="–ù–∏–∫ –∑–∞–Ω—è—Ç!";}
    else{
      db.ref("users/"+nick).set({password:pass,avatar:localStorage.getItem("avatar")||""});
      currentUser = nick;
      localStorage.setItem("nickname", nick);
      document.getElementById("welcomeMsg").innerText = `–ü—Ä–∏–≤–µ—Ç, ${nick}`;
      closeAuth(); loadReviews(); resetReviewForm();
    }
  });
};

// ---------- Login ----------
document.getElementById("btnLogin").onclick = () => {
  let nick = document.getElementById("authNick").value.trim();
  let pass = document.getElementById("authPass").value.trim();
  const msg = document.getElementById("authMsg");
  if(!nick||!pass){msg.innerText="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å!";return;}
  db.ref("users/"+nick).get().then(snap=>{
    const user = snap.val();
    if(user && user.password===pass){
      currentUser = nick;
      localStorage.setItem("nickname", nick);
      if(user.avatar){
        localStorage.setItem("avatar", user.avatar);
        const img = document.getElementById("avatarImg");
        img.src = user.avatar; img.style.display="block";
        document.getElementById("avatarPlus").style.display="none";
      } else {
        localStorage.removeItem("avatar");
        document.getElementById("avatarImg").style.display="none";
        document.getElementById("avatarPlus").style.display="block";
      }
      document.getElementById("welcomeMsg").innerText = `–ü—Ä–∏–≤–µ—Ç, ${nick}`;
      closeAuth(); loadReviews(); resetReviewForm();
    } else msg.innerText="–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫ –∏–ª–∏ –ø–∞—Ä–æ–ª—å!";
  });
};

// ---------- Pages ----------
function openPage(id,event){document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));document.getElementById(id).classList.add("active");if(event)document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));if(event)event.currentTarget.classList.add("active");}

// ---------- Cover ----------
const coverInput = document.getElementById("coverInput");
coverInput.addEventListener("change", function(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{document.getElementById("coverPreview").src=reader.result;}
  reader.readAsDataURL(file);
});

// ---------- Sliders ----------
const vibeMultipliers={1:1,2:1.0675,3:1.1349,4:1.2024,5:1.2699,6:1.3373,7:1.4048,8:1.4723,9:1.5397,10:1.6072};
for(let i=1;i<=5;i++)document.getElementById("s"+i).addEventListener("input",updateScore);
function updateScore(){let base=0;for(let i=1;i<=4;i++){let v=parseInt(document.getElementById("s"+i).value);document.getElementById("v"+i).innerText=v;updateSliderProgress(document.getElementById("s"+i));base+=v;}let vibe=parseInt(document.getElementById("s5").value);document.getElementById("v5").innerText=vibe;updateSliderProgress(document.getElementById("s5"));let final=Math.round((base*1.4)*vibeMultipliers[vibe]);document.getElementById("total").innerText=final;}
function updateSliderProgress(slider){let val=(slider.value-slider.min)/(slider.max-slider.min)*100;slider.style.background=`linear-gradient(to right, rgba(100,150,255,0.6) 0%, rgba(100,150,255,0.6) ${val}%, rgba(255,255,255,0.2) ${val}%, rgba(255,255,255,0.2) 100%)`;}
updateScore();

// ---------- Save Review (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±–ª–æ–∂–∫–∏) ----------
async function saveReview(){
  if(!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å!");

  let coverURL = document.getElementById("coverPreview").src || "";
  
  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
  if(coverInput.files[0]){
    const file = coverInput.files[0];
    const storageRef = storage.ref('covers/'+Date.now()+'_'+file.name);
    await storageRef.put(file);
    coverURL = await storageRef.getDownloadURL();
  }

  const review = {
    author: currentUser,
    avatar: localStorage.getItem("avatar")||"",
    artist: document.getElementById("artist").value.trim(),
    album: document.getElementById("album").value.trim(),
    cover: coverURL,
    scores: [...Array(5)].map((_,i)=>parseInt(document.getElementById("s"+(i+1)).value)),
    text: document.getElementById("text").value,
    total: parseInt(document.getElementById("total").innerText),
    awards: [...document.querySelectorAll(".award input")].map(inp=>inp.checked)
  };

  if(editingIndex !== null){
    db.ref("reviews/"+editingIndex).set(review);
    editingIndex = null;
  } else {
    db.ref("reviews").push(review);
  }

  resetReviewForm();
}

// ---------- Reset Form ----------
function resetReviewForm(){
  document.getElementById("coverPreview").src="";
  document.getElementById("text").value="";
  document.getElementById("artist").value="";
  document.getElementById("album").value="";
  for(let i=1;i<=5;i++){document.getElementById("s"+i).value=5;updateSliderProgress(document.getElementById("s"+i));}
  document.querySelectorAll(".award input").forEach(inp=>inp.checked=false);
  updateScore();
}

// ---------- Load Reviews ----------
function loadReviews(){
  db.ref("reviews").on("value", snapshot=>{
    const reviews = snapshot.val() || {};
    renderTopReviews(Object.entries(reviews));
  });
}

// ---------- Render ----------
function renderTopReviews(entries){
  const list=document.getElementById("home"); list.innerHTML="";
  entries.sort((a,b)=>b[1].total-a[1].total).forEach(([key,r],i)=>{
    const card=document.createElement("div");
    card.className="card";
    let badges=r.awards.map((a,j)=>a?`<span>${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</span>`:"").join("");
    if(!badges) badges='<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>';
    card.dataset.key=key;
    card.innerHTML=`<div class="rank">${i+1}</div>${r.cover?`<img src="${r.cover}">`:`<div style="width:40px;height:40px;border-radius:6px;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;color:#aaa;font-size:12px;">?</div>`}<span class="title">${r.artist} ‚Äî ${r.album}</span><div class="badges">${badges}</div><span class="score">${r.total}</span>`;
    card.onclick=()=>showPreview(key,r); list.appendChild(card);
  });
}

// ---------- Modal Preview ----------
const previewModal=document.getElementById("previewModal");
const previewContent=document.getElementById("previewContent");
const editBtn=document.getElementById("editBtn");
const deleteBtn=document.getElementById("deleteBtn");
const confirmModal=document.getElementById("confirmModal");
const confirmYes=document.getElementById("confirmYes");
const confirmNo=document.getElementById("confirmNo");
let currentKey=null;

function showPreview(key,r){
  currentKey=key;
  previewContent.innerHTML=`<div class="top"><div class="cover-wrapper"><img class="cover" src="${r.cover||''}"></div><div class="meta"><input type="text" value="${r.artist}" disabled style="margin-bottom:4px;"><input type="text" value="${r.album}" disabled style="margin-bottom:4px;"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;opacity:0.85;font-size:12px;">${r.avatar?`<img src="${r.avatar}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`:""}<span>–ê–≤—Ç–æ—Ä: ${r.author}</span></div><div class="award-container">${r.awards.map((a,j)=>a?`<label class="award"><input type="checkbox" checked disabled> ${["üñº –û–±–ª–æ–∂–∫–∞ –º–µ—Å—è—Ü–∞","üíø –ê–ª—å–±–æ–º –º–µ—Å—è—Ü–∞","üé¨ –ö–ª–∏–ø –º–µ—Å—è—Ü–∞","üèÜ –ê–ª—å–±–æ–º –≥–æ–¥–∞"][j]}</label>`:"").join("") || '<span>–ù–µ—Ç –Ω–æ–º–∏–Ω–∞—Ü–∏–π</span>'}</div></div></div>${r.scores.map((s,i)=>`<div class="block ${i===4?'vibe':''}"><div class="label">${["–†–∏—Ñ–º—ã / –û–±—Ä–∞–∑—ã","–°—Ç—Ä—É–∫—Ç—É—Ä–∞ / –†–∏—Ç–º–∏–∫–∞","–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª—è","–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å / –•–∞—Ä–∏–∑–º–∞","–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ / –í–∞–π–±"][i]} <span>${s}</span></div></div>`).join('')}<div class="result"><span>${r.total}</span><span class="small"> / 90</span></div><textarea disabled>${r.text}</textarea>`;
  previewModal.classList.add('show');
}

editBtn.onclick=()=>{
  previewModal.classList.remove('show');
  db.ref("reviews/"+currentKey).get().then(snap=>{
    const r=snap.val();
    editingIndex=currentKey;
    document.getElementById("coverPreview").src=r.cover;
    document.getElementById("text").value=r.text;
    document.getElementById("artist").value=r.artist;
    document.getElementById("album").value=r.album;
    r.scores.forEach((v,i)=>{document.getElementById("s"+(i+1)).value=v;updateSliderProgress(document.getElementById("s"+(i+1)));});
    document.querySelectorAll(".award input").forEach((inp,i)=>inp.checked=r.awards[i]);
    updateScore();
    openPage('review');
  });
}

deleteBtn.onclick=()=>confirmModal.classList.add('show');
confirmNo.onclick=()=>confirmModal.classList.remove('show');
confirmYes.onclick=()=>{confirmModal.classList.remove('show'); previewModal.classList.remove('show'); db.ref("reviews/"+currentKey).remove();}
previewModal.addEventListener('click', e=>{if(e.target===previewModal) previewModal.classList.remove('show');});
confirmModal.addEventListener('click', e=>{if(e.target===confirmModal) confirmModal.classList.remove('show');});

// ---------- Init ----------
window.addEventListener("load", ()=>{
  const savedName = localStorage.getItem("nickname");
  const savedAvatar = localStorage.getItem("avatar");
  if(savedName){
    currentUser = savedName;
    document.getElementById("welcomeMsg").innerText = `–ü—Ä–∏–≤–µ—Ç, ${savedName}`;
  }
  if(savedAvatar){
    const img = document.getElementById("avatarImg");
    img.src = savedAvatar;
    img.style.display = "block";
    document.getElementById("avatarPlus").style.display = "none";
  }
  loadReviews();
});
openPage('home');
</script>

</body>
</html>
